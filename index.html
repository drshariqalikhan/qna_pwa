<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Portrait Q&A PWA</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PortraitApp">

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">

    <style>
        /* Basic Reset & Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        :root {
            --background-color-light: #f0f0f0;
            --text-color-light: #333333;
            --background-color-dark: #1e1e1e; /* Slightly different dark for splash */
            --text-color-dark: #e0e0e0;
            --accent-color: #007aff;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevents scrollbars on body itself */
            overscroll-behavior: none;
            position: fixed;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
                Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            line-height: 1.6;
        }

        /* Splash Screen Styles */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000; /* Black background */
            color: #ffffff;
            display: flex; /* Used to center content */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 9999; /* Ensure it's on top */
            padding: 20px;
            padding-top: env(safe-area-inset-top);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
        }

        #splash-screen p {
            font-size: 1.2em;
        }

        /* Main App Content Container - Initially hidden */
        #app-main-content {
            display: none; /* Hidden by default */
            width: 100%;
            height: 100%;
            background-color: var(--background-color-light); /* Body background for the app */
            color: var(--text-color-light);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-y: auto; /* Allow scrolling for content longer than screen */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */

            display: flex;
            flex-direction: column;
            align-items: center;
            /* justify-content: center; Removed to allow content to flow from top */
            text-align: center;
            padding-top: env(safe-area-inset-top);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
        }

        #app-main-content.dark-mode {
            background-color: var(--background-color-dark);
            color: var(--text-color-dark);
        }

        /* Specific UI elements within the app */
        .app-ui-wrapper {
            display: block;
            width: 90%;
            max-width: 600px;
            padding: 20px 0; /* Adjusted padding */
        }

        h1 {
            font-size: 1.8em;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        p { /* General paragraph styling */
            margin-bottom: 20px;
        }

        button {
            padding: 12px 25px;
            font-size: 1em;
            cursor: pointer;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }

        button:hover {
            opacity: 0.8;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #app-main-content.dark-mode button:disabled {
            background-color: #555555;
            color: #888888;
        }


        /* Q&A Section Specific Styles */
        #qna-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
            width: 100%;
        }
        #app-main-content.dark-mode #qna-section {
            border-top-color: #444;
        }


        #qna-section h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        #qna-section label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            text-align: left;
            -webkit-user-select: text; /* Allow selecting label text */
            user-select: text;
        }

        #qna-section textarea,
        #qna-section input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.9em;
            background-color: #fff;
            color: #333;
            -webkit-user-select: text; /* Allow selecting text in inputs */
            user-select: text;
            line-height: 1.4;
        }

        #qna-section textarea {
            min-height: 100px; /* Ensure textarea has a decent height */
            resize: vertical;
        }


        #app-main-content.dark-mode #qna-section textarea,
        #app-main-content.dark-mode #qna-section input[type="text"] {
            background-color: #3a3a3a;
            color: var(--text-color-dark);
            border-color: #555;
        }


        #qna-section button#ask-button {
            margin-top: 10px;
            display: block;
            width: auto;
            margin-left: auto;
            margin-right: auto;
        }

        #answer-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9e9e9;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: left;
            -webkit-user-select: text; /* Allow selecting answer text */
            user-select: text;
        }
        
        #app-main-content.dark-mode #answer-container {
            background-color: #2a2a2a; 
            border-color: #444;
        }

        #answer-container h3 {
            font-size: 1.1em;
            margin-bottom: 8px;
            color: var(--accent-color);
        }

        #answer-text {
            font-size: 1em;
            min-height: 20px;
            white-space: pre-wrap; /* Preserve whitespace and newlines in answer */
            word-wrap: break-word; /* Break long words */
        }
        
        #loading-status {
            margin-top: 15px;
            font-style: italic;
            color: #555;
            text-align: center;
        }
        #app-main-content.dark-mode #loading-status {
            color: #aaa;
        }
    </style>
</head>
<body>

    <!-- Splash Screen -->
    <div id="splash-screen">
        <p>Please rotate your phone to portrait mode to use this app.</p>
    </div>

    <!-- Main Application Content (initially hidden) -->
    <main id="app-main-content">
        <div class="app-ui-wrapper">
            <h1>Portrait Q&A App</h1>
            <p>Use TensorFlow.js to answer questions based on a given passage.</p>
            <button id="theme-toggle-button">Toggle Dark Mode</button>

            <!-- Q&A Section -->
            <section id="qna-section">
                <h2>Ask the AI</h2>
                <p>Provide a passage and a question, and the AI will try to find the answer within the passage.</p>
                
                <label for="passage">Passage (Context):</label>
                <textarea id="passage" rows="8" placeholder="Enter the context or passage here... e.g., 'Google LLC is an American multinational technology company that specializes in Internet-related services and products.'"></textarea>
                
                <label for="question">Question:</label>
                <input type="text" id="question" placeholder="Enter your question here... e.g., 'What is Google?'">
                
                <button id="ask-button">Ask Question</button>
                
                <div id="loading-status" style="display: none;">Loading model...</div>

                <div id="answer-container" style="display: none;">
                    <h3>Answer:</h3>
                    <p id="answer-text">...</p>
                </div>
            </section>
        </div>
    </main>

    <!-- TensorFlow.js and QnA Model -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/qna@latest/dist/qna.min.js"></script>

    <script>
        const splashScreen = document.getElementById('splash-screen');
        const mainAppContent = document.getElementById('app-main-content');
        const themeToggleButton = document.getElementById('theme-toggle-button');

        // Q&A UI Elements
        const passageInput = document.getElementById('passage');
        const questionInput = document.getElementById('question');
        const askButton = document.getElementById('ask-button');
        const answerContainer = document.getElementById('answer-container');
        const answerText = document.getElementById('answer-text');
        const loadingStatus = document.getElementById('loading-status');
        let qnaModel;

        function isPortrait() {
            if (screen.orientation && screen.orientation.type) {
                return screen.orientation.type.includes('portrait');
            }
            return window.innerHeight > window.innerWidth;
        }

        function handleOrientationChange() {
            console.log("Handling orientation change. Current type:", screen.orientation ? screen.orientation.type : "N/A");
            if (isPortrait()) {
                splashScreen.style.display = 'none';
                mainAppContent.style.display = 'flex';
                // If model hasn't been loaded yet, and we are now in portrait, load it.
                if (!qnaModel && typeof qna !== 'undefined') { // Check if qna library is loaded
                    loadQnAModel();
                }
                console.log("Portrait: Showing app content.");
            } else {
                splashScreen.style.display = 'flex';
                mainAppContent.style.display = 'none';
                console.log("Landscape: Showing splash screen.");
            }
        }
        
        async function loadQnAModel() {
            if (qnaModel) return; // Already loaded

            loadingStatus.textContent = 'Loading Q&A model...';
            loadingStatus.style.display = 'block';
            askButton.disabled = true;
            try {
                qnaModel = await qna.load();
                console.log('Q&A Model loaded.');
                loadingStatus.textContent = 'Model loaded. Ready to answer questions.';
                askButton.disabled = false;
                // Hide status after a short delay if successfully loaded
                setTimeout(() => {
                    if (loadingStatus.textContent.includes('Model loaded')) {
                         loadingStatus.style.display = 'none';
                    }
                }, 2000);
            } catch (error) {
                console.error('Failed to load Q&A model:', error);
                loadingStatus.textContent = 'Error loading Q&A model. Please refresh or check console.';
                loadingStatus.style.color = 'red'; // Make error more visible
                askButton.disabled = true; // Keep button disabled
            }
        }

        async function findAnswers() {
            if (!qnaModel) {
                answerText.textContent = 'Model not loaded yet. Please wait or try refreshing.';
                answerContainer.style.display = 'block';
                return;
            }

            const passage = passageInput.value.trim();
            const question = questionInput.value.trim();

            if (!passage || !question) {
                answerText.textContent = 'Please provide both a passage and a question.';
                answerContainer.style.display = 'block';
                return;
            }

            loadingStatus.textContent = 'Finding answers...';
            loadingStatus.style.display = 'block';
            askButton.disabled = true;
            answerContainer.style.display = 'none'; // Hide previous answer

            try {
                const answers = await qnaModel.findAnswers(question, passage);
                console.log('Answers:', answers);
                if (answers && answers.length > 0) {
                    // Displaying the top answer, could format multiple if desired
                    let topAnswer = answers[0];
                    // Sort by score to be sure, though often they are.
                    // answers.sort((a, b) => b.score - a.score); 
                    // topAnswer = answers[0];
                    answerText.textContent = `${topAnswer.text} (Confidence: ${topAnswer.score.toFixed(3)})`;
                } else {
                    answerText.textContent = 'No answer found in the provided passage.';
                }
            } catch (error) {
                console.error('Error finding answers:', error);
                answerText.textContent = 'An error occurred while trying to find answers.';
            } finally {
                loadingStatus.style.display = 'none';
                answerContainer.style.display = 'block';
                askButton.disabled = false;
            }
        }

        // Initial check on load
        window.addEventListener('load', () => {
            applyTheme(); // Apply theme first
            setTimeout(handleOrientationChange, 150); 
            // Model loading is now triggered by handleOrientationChange when portrait view is active
            // and qna library is available.
        });

        if (screen.orientation) {
            screen.orientation.addEventListener('change', () => {
                setTimeout(handleOrientationChange, 150);
            });
        } else {
            window.addEventListener('orientationchange', () => {
                setTimeout(handleOrientationChange, 150);
            });
        }

        const applyTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                mainAppContent.classList.add('dark-mode');
            } else {
                mainAppContent.classList.remove('dark-mode');
            }
        };

        themeToggleButton.addEventListener('click', () => {
            mainAppContent.classList.toggle('dark-mode');
            localStorage.setItem('theme', mainAppContent.classList.contains('dark-mode') ? 'dark' : 'light');
        });

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (!localStorage.getItem('theme')) {
                applyTheme();
            }
        });

        // Event listener for the Q&A ask button
        askButton.addEventListener('click', findAnswers);

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw-workbox.js')
                    .then(registration => {
                        console.log('Workbox ServiceWorker: Registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.error('Workbox ServiceWorker: Registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
