<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Portrait Q&A PWA with Wikipedia</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QnA WikiPWA">

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">

    <style>
        /* Basic Reset & Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        :root {
            --background-color-light: #f0f0f0;
            --text-color-light: #333333;
            --background-color-dark: #1e1e1e;
            --text-color-dark: #e0e0e0;
            --accent-color: #007aff;
            --border-color-light: #ccc;
            --border-color-dark: #444;
            --input-bg-light: #fff;
            --input-text-light: #333;
            --input-bg-dark: #3a3a3a;
            --input-text-dark: var(--text-color-dark);
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none;
            position: fixed;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
                Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            line-height: 1.6;
        }

        /* Splash Screen Styles */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 9999;
            padding: 20px;
            padding-top: env(safe-area-inset-top);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
        }

        #splash-screen p {
            font-size: 1.2em;
        }

        /* Main App Content Container */
        #app-main-content {
            display: none;
            width: 100%;
            height: 100%;
            background-color: var(--background-color-light);
            color: var(--text-color-light);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding-top: env(safe-area-inset-top);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
        }

        #app-main-content.dark-mode {
            background-color: var(--background-color-dark);
            color: var(--text-color-dark);
        }

        .app-ui-wrapper {
            display: block;
            width: 90%;
            max-width: 600px;
            padding: 20px 0;
        }

        h1 {
            font-size: 1.8em;
            margin-bottom: 15px;
            color: var(--accent-color);
        }
        
        h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        p {
            margin-bottom: 20px;
            -webkit-user-select: text;
            user-select: text;
        }

        button {
            padding: 12px 25px;
            font-size: 1em;
            cursor: pointer;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        button:hover {
            opacity: 0.8;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #app-main-content.dark-mode button:disabled {
            background-color: #555555;
            color: #888888;
        }

        label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            text-align: left;
            -webkit-user-select: text;
            user-select: text;
        }

        textarea,
        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color-light);
            border-radius: 5px;
            font-size: 0.9em;
            background-color: var(--input-bg-light);
            color: var(--input-text-light);
            -webkit-user-select: text;
            user-select: text;
            line-height: 1.4;
        }
        #app-main-content.dark-mode textarea,
        #app-main-content.dark-mode input[type="text"] {
            background-color: var(--input-bg-dark);
            color: var(--input-text-dark);
            border-color: var(--border-color-dark);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .section-divider {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color-light);
        }
        #app-main-content.dark-mode .section-divider {
            border-top-color: var(--border-color-dark);
        }
        
        /* Wikipedia Search Section */
        #wiki-search-section {
             /* No top border needed if it's the first section */
        }
        #wiki-search-button {
            display: block;
            width: auto;
            margin: 10px auto;
        }
        #wiki-status {
            margin-top: 10px;
            font-style: italic;
            font-size: 0.9em;
            min-height: 1.2em; /* Reserve space to prevent layout jump */
             -webkit-user-select: text;
            user-select: text;
        }
        #app-main-content.dark-mode #wiki-status {
            color: #aaa;
        }


        /* Q&A Section Specific Styles */
        #qna-section button#ask-button {
            margin-top: 10px;
            display: block;
            width: auto;
            margin-left: auto;
            margin-right: auto;
        }

        #answer-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9e9e9;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: left;
            -webkit-user-select: text;
            user-select: text;
        }
        #app-main-content.dark-mode #answer-container {
            background-color: #2a2a2a; 
            border-color: var(--border-color-dark);
        }

        #answer-container h3 {
            font-size: 1.1em;
            margin-bottom: 8px;
            color: var(--accent-color);
        }

        #answer-text {
            font-size: 1em;
            min-height: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        #loading-status { /* For TFJS model loading */
            margin-top: 15px;
            font-style: italic;
            color: #555;
            text-align: center;
            min-height: 1.2em;
        }
        #app-main-content.dark-mode #loading-status {
            color: #aaa;
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <p>Please rotate your phone to portrait mode to use this app.</p>
    </div>

    <main id="app-main-content">
        <div class="app-ui-wrapper">
            <h1>Portrait Q&A App</h1>
            <p>Search Wikipedia for context, then ask the AI a question about it.</p>
            <button id="theme-toggle-button">Toggle Dark Mode</button>

            <!-- Wikipedia Search Section -->
            <section id="wiki-search-section" class="section-divider">
                <h2>1. Find Context on Wikipedia</h2>
                <label for="wiki-search-query">Wikipedia Search Term:</label>
                <input type="text" id="wiki-search-query" placeholder="e.g., 'Artificial Intelligence'">
                <button id="wiki-search-button">Search Wikipedia</button>
                <div id="wiki-status"></div>
            </section>

            <!-- Q&A Section -->
            <section id="qna-section" class="section-divider">
                <h2>2. Ask the AI</h2>
                
                <label for="passage">Passage (Context from Wikipedia):</label>
                <textarea id="passage" rows="10" placeholder="Context from Wikipedia will appear here after searching..."></textarea>
                
                <label for="question">Question about the Passage:</label>
                <input type="text" id="question" placeholder="e.g., 'What are the main goals of AI?'">
                
                <button id="ask-button">Ask Question</button>
                
                <div id="loading-status" style="display: none;">Loading model...</div>

                <div id="answer-container" style="display: none;">
                    <h3>Answer:</h3>
                    <p id="answer-text">...</p>
                </div>
            </section>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/qna@latest/dist/qna.min.js"></script>

    <script>
        const splashScreen = document.getElementById('splash-screen');
        const mainAppContent = document.getElementById('app-main-content');
        const themeToggleButton = document.getElementById('theme-toggle-button');

        // Wikipedia UI Elements
        const wikiSearchQueryInput = document.getElementById('wiki-search-query');
        const wikiSearchButton = document.getElementById('wiki-search-button');
        const wikiStatus = document.getElementById('wiki-status');

        // Q&A UI Elements
        const passageInput = document.getElementById('passage');
        const questionInput = document.getElementById('question');
        const askButton = document.getElementById('ask-button');
        const answerContainer = document.getElementById('answer-container');
        const answerText = document.getElementById('answer-text');
        const loadingStatus = document.getElementById('loading-status'); // TFJS Model status
        let qnaModel;

        function isPortrait() {
            if (screen.orientation && screen.orientation.type) {
                return screen.orientation.type.includes('portrait');
            }
            return window.innerHeight > window.innerWidth;
        }

        function handleOrientationChange() {
            console.log("Handling orientation change. Current type:", screen.orientation ? screen.orientation.type : "N/A");
            if (isPortrait()) {
                splashScreen.style.display = 'none';
                mainAppContent.style.display = 'flex';
                if (!qnaModel && typeof qna !== 'undefined') {
                    loadQnAModel();
                }
                console.log("Portrait: Showing app content.");
            } else {
                splashScreen.style.display = 'flex';
                mainAppContent.style.display = 'none';
                console.log("Landscape: Showing splash screen.");
            }
        }
        
        async function loadQnAModel() {
            if (qnaModel) return; 

            loadingStatus.textContent = 'Loading Q&A model...';
            loadingStatus.style.display = 'block';
            askButton.disabled = true;
            try {
                qnaModel = await qna.load();
                console.log('Q&A Model loaded.');
                loadingStatus.textContent = 'Model loaded. Ready to answer questions.';
                askButton.disabled = false;
                setTimeout(() => {
                    if (loadingStatus.textContent.includes('Model loaded')) {
                         loadingStatus.style.display = 'none';
                    }
                }, 2000);
            } catch (error) {
                console.error('Failed to load Q&A model:', error);
                loadingStatus.textContent = 'Error loading Q&A model. Please refresh.';
                loadingStatus.style.color = 'red';
                askButton.disabled = true;
            }
        }

        async function searchWikipediaAndFetchContent() {
            const query = wikiSearchQueryInput.value.trim();
            if (!query) {
                wikiStatus.textContent = 'Please enter a search term.';
                wikiStatus.style.color = 'orange';
                return;
            }

            wikiStatus.textContent = 'Searching Wikipedia...';
            wikiStatus.style.color = 'inherit'; // Reset color
            wikiSearchButton.disabled = true;
            passageInput.value = ''; // Clear previous passage

            try {
                // 1. Search for the page title
                const searchUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*`;
                const searchResponse = await fetch(searchUrl);
                if (!searchResponse.ok) throw new Error(`Wikipedia search API error: ${searchResponse.status}`);
                const searchData = await searchResponse.json();

                if (!searchData.query || !searchData.query.search || searchData.query.search.length === 0) {
                    wikiStatus.textContent = `No Wikipedia results found for "${query}".`;
                    wikiStatus.style.color = 'orange';
                    wikiSearchButton.disabled = false;
                    return;
                }

                const topResultTitle = searchData.query.search[0].title;
                wikiStatus.textContent = `Found article: "${topResultTitle}". Fetching content...`;

                // 2. Fetch the extract of the top result
                // Using exintro for the first section, explaintext for plain text version.
                const contentUrl = `https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&titles=${encodeURIComponent(topResultTitle)}&format=json&origin=*`;
                const contentResponse = await fetch(contentUrl);
                 if (!contentResponse.ok) throw new Error(`Wikipedia content API error: ${contentResponse.status}`);
                const contentData = await contentResponse.json();
                
                const pages = contentData.query.pages;
                const pageId = Object.keys(pages)[0]; // Get the first (and only) page ID

                if (pageId === "-1") { // Page not found or invalid title somehow
                     wikiStatus.textContent = `Could not retrieve content for "${topResultTitle}".`;
                     wikiStatus.style.color = 'red';
                     wikiSearchButton.disabled = false;
                     return;
                }
                
                const extract = pages[pageId].extract;

                if (extract) {
                    passageInput.value = extract;
                    wikiStatus.textContent = `Content for "${topResultTitle}" loaded into passage.`;
                    setTimeout(() => {
                        if(wikiStatus.textContent.startsWith('Content for')) wikiStatus.textContent = '';
                    }, 3000);
                } else {
                    passageInput.value = `No extract found for "${topResultTitle}". You might want to try a different search term or check the article on Wikipedia directly.`;
                    wikiStatus.textContent = `No text extract found for "${topResultTitle}".`;
                    wikiStatus.style.color = 'orange';
                }

            } catch (error) {
                console.error('Wikipedia search/fetch error:', error);
                wikiStatus.textContent = `Error: ${error.message}. Check console.`;
                wikiStatus.style.color = 'red';
            } finally {
                wikiSearchButton.disabled = false;
            }
        }


        async function findAnswers() {
            if (!qnaModel) {
                answerText.textContent = 'Model not loaded yet. Please wait.';
                answerContainer.style.display = 'block';
                return;
            }

            const passage = passageInput.value.trim();
            const question = questionInput.value.trim();

            if (!passage || !question) {
                answerText.textContent = 'Please ensure there is a passage (e.g., from Wikipedia search) and a question.';
                answerContainer.style.display = 'block';
                return;
            }

            loadingStatus.textContent = 'Finding answers...';
            loadingStatus.style.display = 'block'; // Show TFJS loading status, not wiki status
            askButton.disabled = true;
            answerContainer.style.display = 'none';

            try {
                const answers = await qnaModel.findAnswers(question, passage);
                console.log('Answers:', answers);
                if (answers && answers.length > 0) {
                    answers.sort((a, b) => b.score - a.score); // Sort by score, highest first
                    let answerDisplay = answers.slice(0, 3).map(ans => 
                        `${ans.text} (Confidence: ${ans.score.toFixed(3)})`
                    ).join('\n\n');
                    if (answers.length === 0) answerDisplay = "No answer found.";
                    
                    answerText.textContent = answerDisplay || 'No answer found in the provided passage.';
                } else {
                    answerText.textContent = 'No answer found in the provided passage.';
                }
            } catch (error) {
                console.error('Error finding answers:', error);
                answerText.textContent = 'An error occurred while trying to find answers.';
            } finally {
                loadingStatus.style.display = 'none';
                answerContainer.style.display = 'block';
                askButton.disabled = false;
            }
        }

        // Initial check on load
        window.addEventListener('load', () => {
            applyTheme();
            setTimeout(handleOrientationChange, 150); 
        });

        if (screen.orientation) {
            screen.orientation.addEventListener('change', () => {
                setTimeout(handleOrientationChange, 150);
            });
        } else {
            window.addEventListener('orientationchange', () => {
                setTimeout(handleOrientationChange, 150);
            });
        }

        const applyTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                mainAppContent.classList.add('dark-mode');
            } else {
                mainAppContent.classList.remove('dark-mode');
            }
        };

        themeToggleButton.addEventListener('click', () => {
            mainAppContent.classList.toggle('dark-mode');
            localStorage.setItem('theme', mainAppContent.classList.contains('dark-mode') ? 'dark' : 'light');
        });

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (!localStorage.getItem('theme')) {
                applyTheme();
            }
        });

        // Event listener for Wikipedia search button
        wikiSearchButton.addEventListener('click', searchWikipediaAndFetchContent);
        // Allow Enter key for Wikipedia search
        wikiSearchQueryInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission if it were in a form
                searchWikipediaAndFetchContent();
            }
        });


        // Event listener for the Q&A ask button
        askButton.addEventListener('click', findAnswers);
        // Allow Enter key for asking question if passage is present
        questionInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && passageInput.value.trim() && questionInput.value.trim()) {
                event.preventDefault();
                findAnswers();
            }
        });


        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw-workbox.js')
                    .then(registration => {
                        console.log('Workbox ServiceWorker: Registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.error('Workbox ServiceWorker: Registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
