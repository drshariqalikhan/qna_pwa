<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Offline Gemma Chat</title>
    
    <!-- PWA & iOS ENHANCEMENT TAGS -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#252526">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Gemma Chat">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <!-- CSS STYLES (Unchanged) -->
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #1e1e1e; color: #e0e0e0; margin: 0; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 700px; height: 100vh; display: flex; flex-direction: column; background-color: #252526; }
        header { padding: 1rem; padding-top: calc(1rem + var(--safe-area-inset-top)); background-color: #333333; text-align: center; border-bottom: 1px solid #444; flex-shrink: 0; }
        h1 { margin: 0; font-size: 1.2rem; }
        #status { font-size: 0.8rem; color: #aaaaaa; margin-top: 5px; min-height: 1em; transition: color 0.3s; }
        #status.error { color: #ff453a; }
        #chat-container { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        .message { padding: 0.8rem 1rem; border-radius: 1rem; max-width: 85%; word-wrap: break-word; line-height: 1.4; }
        .message.you { background-color: #007aff; color: white; align-self: flex-end; border-bottom-right-radius: 0.2rem; }
        .message.ai { background-color: #3a3a3c; align-self: flex-start; border-bottom-left-radius: 0.2rem; }
        .message.error { background-color: #5c2320; align-self: flex-start; border-bottom-left-radius: 0.2rem; }
        footer { display: flex; padding: 1rem; padding-bottom: calc(1rem + var(--safe-area-inset-bottom)); border-top: 1px solid #444; background-color: #333333; flex-shrink: 0; }
        #message-input { flex-grow: 1; background-color: #3c3c3c; border: 1px solid #555; color: white; padding: 0.8rem; border-radius: 1rem; margin-right: 0.5rem; font-size: 1rem; }
        #send-btn { background-color: #007aff; color: white; border: none; padding: 0.8rem 1.2rem; border-radius: 1rem; cursor: pointer; font-weight: bold; }
        #send-btn:disabled, #message-input:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <h1>On-Device Gemma Chat</h1>
            <p id="status">Initializing application...</p>
        </header>
        <main id="chat-container"></main>
        <footer>
            <input type="text" id="message-input" placeholder="Loading AI..." disabled>
            <button id="send-btn" disabled>Send</button>
        </footer>
    </div>

    <script type="module">
        // UI Elements
        const status = document.getElementById('status');
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        
        /**
         * A helper function for logging events to the console and updating the user-facing status.
         * @param {string} message - The message to log.
         * @param {'log'|'info'|'warn'|'error'} level - The console log level.
         * @param {boolean} updateUserStatus - Whether to update the on-screen status text.
         */
        function logEvent(message, level = 'log', updateUserStatus = false) {
            console[level](`[AppEvent] - ${new Date().toISOString()} - ${message}`);
            if (updateUserStatus) {
                status.textContent = message;
                status.classList.toggle('error', level === 'error');
            }
        }
        
        // --- 1. PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                logEvent('Page loaded. Attempting to register Service Worker...', 'info');
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => logEvent(`Service Worker registered successfully. Scope: ${reg.scope}`, 'info'))
                    .catch(err => logEvent(`Service Worker registration failed: ${err}`, 'error', true));
            });
        } else {
            logEvent('Service Worker not supported in this browser.', 'warn');
        }

        // --- 2. Main Application Logic ---
        async function main() {
            try {
                // --- 2a. Import AI Library ---
                logEvent('Importing Transformers.js library...', 'log');
                const { pipeline, env } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1');
                env.allowRemoteModels = true;
                logEvent('Transformers.js library imported successfully.', 'log');
                
                // --- 2b. Load AI Model ---
                const model_id = 'Xenova/gemma-2b-it';
                logEvent(`Attempting to load AI model: ${model_id}`, 'info', true);

                const generator = await pipeline('text-generation', model_id, {
                    progress_callback: (data) => {
                        if (data.status === 'progress') {
                            const progress = (data.progress || 0).toFixed(2);
                            logEvent(`Downloading: ${data.file} (${progress}%)`, 'log', true);
                        }
                    }
                });
                
                logEvent('AI Model loaded and ready!', 'info', true);

                // --- 2c. Enable UI ---
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.placeholder = 'Ask something...';
                addMessage('AI', 'Hello! I am Google\'s Gemma model running entirely on your device. How can I help you?');
                logEvent('UI enabled. Ready for interaction.', 'info');

                // --- 3. Setup Event Handlers ---
                sendBtn.addEventListener('click', () => handleSend(generator));
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSend(generator);
                    }
                });

            } catch (error) {
                logEvent(`CRITICAL: Failed to initialize the application. ${error}`, 'error', true);
            }
        }
        
        async function handleSend(generator) {
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;
            
            logEvent(`User submitted message: "${userMessage}"`, 'log');
            addMessage('You', userMessage);
            messageInput.value = '';
            messageInput.disabled = true;
            sendBtn.disabled = true;

            const thinkingMessage = addMessage('AI', '...');

            try {
                // --- 4. AI Inference ---
                const prompt = `<start_of_turn>user\n${userMessage}<end_of_turn>\n<start_of_turn>model\n`;
                logEvent(`Formatted prompt for model:\n${prompt}`, 'log');
                logEvent('Starting AI generation...', 'info');

                const result = await generator(prompt, { max_new_tokens: 200, temperature: 0.7, top_k: 50, do_sample: true });
                
                logEvent('AI generation complete.', 'log');
                const aiResponse = result[0].generated_text.split('<start_of_turn>model\n')[1].trim();
                logEvent(`Parsed AI response: "${aiResponse}"`, 'log');

                thinkingMessage.textContent = aiResponse;

            } catch (error) {
                logEvent(`Error during AI generation: ${error}`, 'error');
                addMessage('AI', 'Sorry, I encountered an error while processing your request.', 'error');
            } finally {
                // --- 5. Re-enable UI ---
                logEvent('Re-enabling input fields.', 'log');
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function addMessage(sender, text, type = sender.toLowerCase()) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', type);
            messageElement.textContent = text;
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageElement;
        }

        // Start the application
        main();
    </script>
</body>
</html>